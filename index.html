<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloudflare IPv4 → IPv6 変換ツール (Discord IPv6回避用)</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background: #f9f9f9; }
    h1, h2 { text-align: center; }
    textarea, input, select { width: 100%; padding: 12px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
    button { padding: 12px 20px; font-size: 16px; background: #1a73e8; color: white; border: none; cursor: pointer; margin: 5px 0; border-radius: 4px; }
    button:hover { background: #1557b0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    #result { margin-top: 20px; }
    .copy-btn { padding: 6px 12px; background: #eee; border: 1px solid #ccc; cursor: pointer; font-size: 14px; border-radius: 4px; }
    footer { margin-top: 50px; text-align: center; color: #666; font-size: 14px; }
    .help { font-size: 14px; color: #666; margin-top: 5px; }

    /* カスタムモーダル */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; }
    .modal-body { line-height: 1.6; margin-bottom: 20px; }
    .modal-footer { text-align: right; }
    .modal-btn { padding: 10px 20px; margin-left: 10px; border-radius: 4px; }
    .modal-btn-cancel { background: #ddd; color: black; }
    .modal-btn-cancel:hover { background: #ccc; }
    .modal-btn-ok { background: #1a73e8; color: white; }
    .modal-btn-ok:hover { background: #1557b0; }
  </style>
</head>
<body>
  <h1>Cloudflare IPv4 → IPv6 変換ツール</h1>
  <p>DiscordのIPv6接続問題回避用。Cloudflare Anycast IPv4から対応IPv6を計算します。</p>

  <h2>1. IPv4からIPv6変換（複数行対応）</h2>
  <select id="prefixSelect">
    <option value="2606:4700::">2606:4700:: (標準)</option>
    <option value="2606:4700:4700::4700">2606:4700:4700::4700 (拡張)</option>
  </select>
  <textarea id="ipv4Input" rows="6" placeholder="例:&#10;1.1.1.1&#10;104.16.18.43&#10;104.16.20.43"></textarea>
  <button onclick="convertMultiple()">一括変換</button>

  <div id="result"></div>

  <h2>2. ドメインからIPv4取得 → IPv6変換（DoH使用）</h2>
  <input type="text" id="domainInput" placeholder="例: discord.com または gateway.discord.gg">
  <select id="dohProvider">
    <option value="https://security.cloudflare-dns.com/dns-query">Cloudflare Security (1.1.1.2 - Malwareブロック)</option>
    <option value="https://cloudflare-dns.com/dns-query">Cloudflare Standard (1.1.1.1)</option>
    <option value="https://family.cloudflare-dns.com/dns-query">Cloudflare Family (1.1.1.3 - Malware+成人ブロック)</option>
    <option value="https://dns.google/resolve">Google Public DNS (8.8.8.8)</option>
    <option value="https://dns.quad9.net/dns-query">Quad9 Secured (9.9.9.9 - Malwareブロック)</option>
    <option value="https://dns9.quad9.net/dns-query">Quad9 Unsecured (9.9.9.10 - ブロックなし)</option>
    <option value="https://all.dns.mullvad.net/dns-query">Mullvad DNS (no blocking, プライバシー重視)</option>
    <option value="https://doh-jp.blahdns.com/dns-query">BlahDNS Japan (adblock, 日本サーバー)</option>
    <option value="https://dnsforge.de/dns-query">dnsforge.de (ドイツ)</option>
    <option value="https://doh.applied-privacy.net/query">Applied Privacy DNS (オーストリア, プライバシー重視)</option>
    <option value="https://doh.seby.io/dns-query">Seby DNS (オーストラリア)</option>
    <option value="https://doh.libredns.gr/dns-query">LibreDNS (ギリシャ, no logs)</option>
  </select>
  <input type="text" id="customDoh" placeholder="その他: 任意のDoHベースURLを入力 (例: https://dns.adguard.com/dns-query)">
  <p class="help">※クエリパラメータ (?name=...&type=A) は自動で付きます。ベースURLだけ入力してください。</p>
  <button id="queryBtn">Aレコード取得 & IPv6変換</button>

  <footer>
    Made for Discord IPv6 workaround | <a href="https://support.discord.com/hc/en-us/community/posts/360047840052">参考リクエスト</a>
  </footer>

  <!-- カスタムモーダル -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">DNSクエリ実行の確認</div>
      <div class="modal-body" id="modalMessage"></div>
      <div style="margin: 20px 0;">
        <label><input type="checkbox" id="skipToday"> 今日はこのダイアログを再表示しない</label><br><br>
        <label><input type="checkbox" id="skipForever"> 二度とこのダイアログを表示しない（Cookieが無効になるまで）</label>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">キャンセル</button>
        <button class="modal-btn modal-btn-ok" onclick="proceedQuery()">続行</button>
      </div>
    </div>
  </div>

  <script>
    // Cookieヘルパー
    function setCookie(name, value, days) {
      let expires = "";
      if (days) {
        const date = new Date();
        if (days === 'today') {
          date.setHours(23, 59, 59, 999);
        } else {
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        }
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + value + expires + "; path=/";
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length);
      }
      return null;
    }

    const prefixes = {
      "2606:4700::": "2606:4700::",
      "2606:4700:4700::4700": "2606:4700:4700::4700"
    };

    function convertIPv4ToIPv6(ipv4, prefix) {
      const parts = ipv4.split('.').map(Number);
      if (parts.length !== 4 || parts.some(n => isNaN(n) || n < 0 || n > 255)) return null;

      let ipv6 = prefix;
      for (let i = 0; i < 4; i++) {
        if (prefix === "2606:4700::" && i === 2) ipv6 += ":";
        if (prefix === "2606:4700:4700::4700" && i === 2) ipv6 += "4700:";
        ipv6 += parts[i].toString(16).padStart(2, "0");
      }
      return ipv6;
    }

    function convertMultiple() {
      const prefix = document.getElementById('prefixSelect').value;
      const input = document.getElementById('ipv4Input').value.trim();
      const lines = input.split('\n').filter(line => line.trim());

      let html = '<table><tr><th>IPv4</th><th>IPv6 (' + prefix + ')</th><th>操作</th></tr>';
      lines.forEach(line => {
        const ipv6 = convertIPv4ToIPv6(line.trim(), prefix);
        if (ipv6) {
          html += `<tr><td>${line}</td><td>${ipv6}</td><td><button class="copy-btn" onclick="navigator.clipboard.writeText('${ipv6}')">コピー</button></td></tr>`;
        } else {
          html += `<tr><td colspan="3" style="color:red;">無効: ${line}</td></tr>`;
        }
      });
      html += '</table>';
      document.getElementById('result').innerHTML = html;
    }

    // モーダル制御
    function showModal(message) {
      document.getElementById('modalMessage').innerHTML = message;
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('confirmModal').style.display = 'none';
    }

    let pendingQuery = null;

    async function proceedQuery() {
      closeModal();

      const skipToday = document.getElementById('skipToday').checked;
      const skipForever = document.getElementById('skipForever').checked;

      if (skipToday || skipForever) {
        setCookie('dohConsentSkipped', 'true', skipForever ? 365 : 'today');
      }

      if (pendingQuery) pendingQuery();
    }

    // 利用規約リンク
    const termsLinks = {
      "https://security.cloudflare-dns.com/dns-query": ["Cloudflare Public DNS", "https://developers.cloudflare.com/1.1.1.1/privacy/public-dns-resolver/"],
      "https://cloudflare-dns.com/dns-query": ["Cloudflare Public DNS", "https://developers.cloudflare.com/1.1.1.1/privacy/public-dns-resolver/"],
      "https://family.cloudflare-dns.com/dns-query": ["Cloudflare Public DNS", "https://developers.cloudflare.com/1.1.1.1/privacy/public-dns-resolver/"],
      "https://dns.google/resolve": ["Google Public DNS", "https://developers.google.com/speed/public-dns/privacy"],
      "https://dns.quad9.net/dns-query": ["Quad9", "https://quad9.net/privacy/"],
      "https://dns9.quad9.net/dns-query": ["Quad9", "https://quad9.net/privacy/"],
      "https://all.dns.mullvad.net/dns-query": ["Mullvad DNS", "https://mullvad.net/en/help/dns-over-https-and-dns-over-tls"],
      "https://doh-jp.blahdns.com/dns-query": ["BlahDNS", "https://blahdns.com/"],
      "https://dnsforge.de/dns-query": ["dnsforge.de", "https://dnsforge.de/"],
      "https://doh.applied-privacy.net/query": ["Applied Privacy", "https://applied-privacy.net/services/dns/"],
      "https://doh.seby.io/dns-query": ["Seby DNS", "https://dns.seby.io/"],
      "https://doh.libredns.gr/dns-query": ["LibreDNS", "https://libredns.gr/privacy/"],
    };

    document.getElementById('queryBtn').addEventListener('click', () => {
      const domain = document.getElementById('domainInput').value.trim();
      if (!domain) return alert('ドメインを入力してください');

      let providerUrl = document.getElementById('dohProvider').value;
      const custom = document.getElementById('customDoh').value.trim();
      if (custom) {
        if (!custom.startsWith('https://')) return alert('カスタムDoH URLは https:// で始まるものを入力してください');
        providerUrl = custom;
      }

      // Cookieでスキップ済みなら即実行
      if (getCookie('dohConsentSkipped') === 'true') {
        performDNSQuery(providerUrl, domain);
        return;
      }

      let providerName = custom ? "指定したDNSサービス" : "選択したDNSサービス";
      let termsLink = null;

      if (!custom && termsLinks[providerUrl]) {
        providerName = termsLinks[providerUrl][0];
        termsLink = termsLinks[providerUrl][1];
      }

      let message = `<p>このツールは<strong>${providerName}</strong>に対してDNS over HTTPS (DoH)クエリを実行します。</p>`;
      message += `<p>続行すると、相手方サービスの利用規約およびプライバシーポリシーが適用されます。</p>`;
      if (termsLink) {
        message += `<p>詳細: <a href="${termsLink}" target="_blank">${termsLink}</a></p>`;
      }

      showModal(message);

      pendingQuery = () => performDNSQuery(providerUrl, domain);
    });

    async function performDNSQuery(providerUrl, domain) {
      const isGoogle = providerUrl.includes('dns.google');
      let url = `${providerUrl}?name=${domain}&type=A`;

      try {
        const headers = isGoogle ? {} : {'accept': 'application/dns-json'};
        const res = await fetch(url, {headers});
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const data = await res.json();
        let ips = [];

        if (isGoogle) {
          ips = (data.Answer || []).filter(a => a.type === 1).map(a => a.data);
        } else {
          ips = (data.Answer || []).filter(a => a.type === 1).map(a => a.data);
        }

        if (ips.length === 0) return alert('Aレコードが見つかりませんでした（ブロックされている可能性も）');

        document.getElementById('ipv4Input').value = ips.join('\n');
        alert(`取得したIPv4 (${ips.length}件):\n${ips.join('\n')}\n→ 上の入力欄にセットしました！変換ボタン押してね`);
        convertMultiple();
      } catch (e) {
        alert('クエリ失敗: ' + e.message + '\nURLが正しいか、DoH対応か確認してください');
      }
    }

    // Ctrl+Enterで変換
    document.getElementById('ipv4Input').addEventListener('keydown', e => {
      if (e.key === 'Enter' && e.ctrlKey) convertMultiple();
    });
  </script>
</body>
</html>
